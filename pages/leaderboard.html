<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Leaderboard - See the top scores for Parts Technician practice exams. Compete with other students!">
  <title>Leaderboard ‚Äì Second Period Practice Tests</title>
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="../assets/css/leaderboard.css">
  <link rel="stylesheet" href="../assets/css/leaderboard-fixes.css">
  <link rel="stylesheet" href="../assets/css/chat.css">

  <!-- Firebase Configuration and Integration -->
  <script src="../config/firebase.config.js"></script>
  <script src="../assets/js/leaderboard-firebase.js"></script>
  
  <script src="../assets/js/leaderboard.js"></script>
  <script src="../script.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="../assets/fingerprint-logger.js"></script>
  <script src="../assets/js/avatar-util.js"></script>
  <script src="../assets/js/chat.js"></script>
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-to-content">Skip to main content</a>

  <!-- Hero header -->
  <header class="site-header site-header--hero" role="banner">
    <div class="header-fog" aria-hidden="true"></div>
    <div class="header-particles" aria-hidden="true"></div>
    <div class="header-content">
      <p class="header-subtitle">Parts Technician ‚Ä¢ Second Period</p>
      <h1>Leaderboard</h1>
      <p>See top scores and compete with other students!</p>
    </div>
  </header>

  <main id="main-content" class="leaderboard-wrapper">
    <!-- Back link -->
    <div class="back-link">
      <a href="../index.html">‚Üê Back to main module selection</a>
    </div>

    <!-- Header section -->
    <section class="leaderboard-header" aria-labelledby="leaderboard-heading">
      <h2 id="leaderboard-heading">Top Scores by Module</h2>
      <p>
        Track your progress and see how you compare to other students.
        Set your display name below to have your scores recorded on the leaderboard.
      </p>
      <div class="leaderboard-status" id="leaderboard-status">
        <span class="status-dot"></span>
        <span id="status-text">Using sample data</span>
      </div>
    </section>

    <!-- Username section -->
    <section class="username-section" aria-labelledby="username-heading">
      <h3 id="username-heading">Your Profile</h3>

      <!-- Display Name -->
      <div style="margin-bottom: 1.5rem;">
        <label for="username-input" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Display Name</label>
        <form class="username-form" id="username-form">
          <input
            type="text"
            id="username-input"
            class="username-input"
            placeholder="Enter your display name"
            maxlength="30"
            autocomplete="off"
            aria-describedby="username-help"
          >
          <button type="submit" class="username-btn">Save Name</button>
        </form>
        <p class="username-current" id="username-current" aria-live="polite"></p>
      </div>

      <!-- Profile Picture -->
      <div style="margin-bottom: 1.5rem;">
        <label for="profile-picture-input" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Profile Picture</label>
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
          <img id="profile-picture-preview" src="" alt="Profile preview" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--color-gray-600);">
          <div style="flex: 1;">
            <!-- File Upload Option -->
            <div style="margin-bottom: 0.5rem;">
              <label for="profile-picture-file" class="username-btn" style="display: inline-block; margin: 0; cursor: pointer; text-align: center; padding: var(--space-3) var(--space-4);">
                üìÅ Upload Image
              </label>
              <input
                type="file"
                id="profile-picture-file"
                accept="image/jpeg,image/png,image/gif,image/webp"
                style="display: none;"
                aria-describedby="profile-picture-help"
              >
              <span id="file-name-display" style="margin-left: 0.5rem; font-size: 0.875rem; color: var(--color-text-secondary);"></span>
            </div>
            <!-- URL Input Option -->
            <form class="username-form" id="profile-picture-form" style="margin-bottom: 0;">
              <input
                type="url"
                id="profile-picture-input"
                class="username-input"
                placeholder="Or paste image URL here..."
                autocomplete="off"
                aria-describedby="profile-picture-help"
              >
              <button type="submit" class="username-btn">Save URL</button>
            </form>
          </div>
        </div>
        <p id="profile-picture-current" style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0.5rem 0 0 0;"></p>
        <p id="profile-picture-help" style="font-size: 0.75rem; color: var(--color-text-muted); margin: 0.5rem 0 0 0;">
          Upload an image file (JPG, PNG, GIF, max 2MB) or paste a URL. Leave blank for auto-generated avatar from your initials.
        </p>
      </div>

      <p id="username-help" class="sr-only">
        Your display name and profile picture will be shown on the leaderboard and in chat.
      </p>
    </section>

    <!-- User Statistics Section -->
    <section class="user-stats-section" aria-labelledby="user-stats-heading">
      <h3 id="user-stats-heading">User Statistics</h3>
      <div class="user-stats-table-container">
        <table class="user-stats-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Username</th>
              <th>Total Exams</th>
              <th>Modules</th>
              <th>Sections</th>
              <th>Best Score</th>
              <th>Avg Score</th>
            </tr>
          </thead>
          <tbody id="user-stats-body">
            <tr>
              <td colspan="7" style="text-align: center; padding: 2rem;">
                Loading user statistics...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Module tabs for filtering -->
    <nav class="leaderboard-tabs" aria-label="Module filter" id="module-tabs">
      <button class="leaderboard-tab active" data-module="all">All Modules</button>
      <button class="leaderboard-tab" data-module="270201">270201</button>
      <button class="leaderboard-tab" data-module="270202">270202</button>
      <button class="leaderboard-tab" data-module="270203">270203</button>
      <button class="leaderboard-tab" data-module="270204">270204</button>
      <button class="leaderboard-tab" data-module="practice">Practice Exams</button>
    </nav>

    <!-- Leaderboard content -->
    <section id="leaderboard-content" aria-live="polite" aria-busy="false">
      <div class="leaderboard-loading" id="loading-indicator">
        <div class="spinner" aria-hidden="true"></div>
        <span>Loading leaderboard...</span>
      </div>
    </section>

    <!-- Tips section -->
    <aside class="tip-callout">
      <p>
        <strong>üí° Tip:</strong> Complete practice exams to appear on the leaderboard.
        Your best score per module is recorded. Keep practicing to improve your ranking!
      </p>
    </aside>
  </main>

  <footer class="site-footer" role="contentinfo">
    <span>Built for Parts Technician ‚Ä¢ Wolf Pack Training</span>
  </footer>

  <script>
    // Leaderboard page initialization
    ;(function() {
      'use strict';

      var currentFilter = 'all';
      var leaderboardData = {};

      // DOM elements
      var contentEl = document.getElementById('leaderboard-content');
      var loadingEl = document.getElementById('loading-indicator');
      var usernameForm = document.getElementById('username-form');
      var usernameInput = document.getElementById('username-input');
      var usernameCurrentEl = document.getElementById('username-current');
      var profilePictureForm = document.getElementById('profile-picture-form');
      var profilePictureInput = document.getElementById('profile-picture-input');
      var profilePicturePreview = document.getElementById('profile-picture-preview');
      var profilePictureCurrentEl = document.getElementById('profile-picture-current');
      var statusEl = document.getElementById('leaderboard-status');
      var statusTextEl = document.getElementById('status-text');
      var tabsEl = document.getElementById('module-tabs');
      var userStatsBody = document.getElementById('user-stats-body');

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', init);

      function init() {
        // Display current username
        updateUsernameDisplay();

        // Display current profile picture
        updateProfilePictureDisplay();

        // Update backend status
        updateBackendStatus();

        // Load user statistics
        loadUserStats();

        // Load leaderboard data
        loadLeaderboard();

        // Set up event listeners
        setupEventListeners();
      }

      function setupEventListeners() {
        // Username form submission
        usernameForm.addEventListener('submit', function(e) {
          e.preventDefault();
          var newName = usernameInput.value.trim();
          if (newName) {
            Leaderboard.username(newName);
            updateUsernameDisplay();
            updateProfilePictureDisplay(); // Update avatar with new name
            usernameInput.value = '';
          }
        });

        // Profile picture file upload
        var profilePictureFile = document.getElementById('profile-picture-file');
        var fileNameDisplay = document.getElementById('file-name-display');

        profilePictureFile.addEventListener('change', function(e) {
          var file = e.target.files[0];
          if (!file) return;

          // Validate file type
          if (!file.type.match(/^image\/(jpeg|jpg|png|gif|webp)$/)) {
            alert('Please upload a valid image file (JPG, PNG, GIF, or WEBP)');
            profilePictureFile.value = '';
            return;
          }

          // Validate file size (max 2MB)
          if (file.size > 2 * 1024 * 1024) {
            alert('Image file is too large. Please upload an image smaller than 2MB.');
            profilePictureFile.value = '';
            return;
          }

          // Show file name
          fileNameDisplay.textContent = file.name;

          // Read file and convert to Data URL
          var reader = new FileReader();
          reader.onload = function(event) {
            var dataUrl = event.target.result;

            if (window.AvatarUtil) {
              window.AvatarUtil.setCustomAvatarUrl(dataUrl);
              updateProfilePictureDisplay();
            }
          };
          reader.onerror = function() {
            alert('Failed to read image file. Please try again.');
            profilePictureFile.value = '';
            fileNameDisplay.textContent = '';
          };
          reader.readAsDataURL(file);
        });

        // Profile picture URL form submission
        profilePictureForm.addEventListener('submit', function(e) {
          e.preventDefault();
          var newUrl = profilePictureInput.value.trim();

          if (window.AvatarUtil) {
            // Validate URL if provided
            if (newUrl && !window.AvatarUtil.isValidImageUrl(newUrl)) {
              alert('Please enter a valid image URL (JPG, PNG, GIF, or from a trusted image host)');
              return;
            }

            window.AvatarUtil.setCustomAvatarUrl(newUrl);
            updateProfilePictureDisplay();
            profilePictureInput.value = '';
            fileNameDisplay.textContent = '';
          }
        });

        // Tab switching
        tabsEl.addEventListener('click', function(e) {
          var tab = e.target.closest('.leaderboard-tab');
          if (!tab) return;
          
          // Update active tab
          var allTabs = tabsEl.querySelectorAll('.leaderboard-tab');
          for (var i = 0; i < allTabs.length; i++) {
            allTabs[i].classList.remove('active');
          }
          tab.classList.add('active');
          
          // Update filter and re-render
          currentFilter = tab.getAttribute('data-module');
          renderLeaderboard();
        });
      }

      function updateUsernameDisplay() {
        var current = Leaderboard.username();
        if (current) {
          usernameCurrentEl.innerHTML = 'Current name: <strong>' + Leaderboard.escapeHtml(current) + '</strong>';
        } else {
          usernameCurrentEl.textContent = 'No display name set. Enter one above to track your scores.';
        }
      }

      function updateProfilePictureDisplay() {
        var current = Leaderboard.username();
        if (!current) current = 'Anonymous';

        if (window.AvatarUtil) {
          // Update preview
          var avatarUrl = window.AvatarUtil.getAvatarUrl(current);
          profilePicturePreview.src = avatarUrl;

          // Update status text
          var customUrl = window.AvatarUtil.getCustomAvatarUrl();
          if (customUrl) {
            profilePictureCurrentEl.innerHTML = 'Using custom image: <a href="' + customUrl + '" target="_blank" style="color: var(--color-primary);">View</a> | <button onclick="clearProfilePicture()" style="background: none; border: none; color: var(--color-primary); cursor: pointer; padding: 0; text-decoration: underline;">Clear</button>';
          } else {
            profilePictureCurrentEl.textContent = 'Using auto-generated avatar from initials';
          }
        }
      }

      // Make clearProfilePicture available globally for the inline onclick
      window.clearProfilePicture = function() {
        if (window.AvatarUtil) {
          window.AvatarUtil.setCustomAvatarUrl('');
          updateProfilePictureDisplay();
        }
      };

      async function updateBackendStatus() {
        var isConfigured = await Leaderboard.isBackendConfigured();
        if (isConfigured) {
          statusEl.classList.add('status-live');
          statusTextEl.textContent = 'Live data connected';
        } else {
          statusEl.classList.remove('status-live');
          statusTextEl.textContent = 'Using sample data (demo mode)';
        }
      }

      async function loadUserStats() {
        try {
          if (window.LeaderboardFirebase && window.LeaderboardFirebase.getPublicUserStats) {
            var userStats = await window.LeaderboardFirebase.getPublicUserStats();
            renderUserStats(userStats);
          } else {
            userStatsBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">User statistics unavailable</td></tr>';
          }
        } catch (error) {
          console.error('Failed to load user stats:', error);
          userStatsBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Failed to load user statistics</td></tr>';
        }
      }

      function renderUserStats(stats) {
        if (!stats || stats.length === 0) {
          userStatsBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No user data available</td></tr>';
          return;
        }

        var html = '';
        for (var i = 0; i < stats.length; i++) {
          var user = stats[i];
          var rankClass = i < 3 ? 'rank-' + (i + 1) : '';
          html += '<tr class="' + rankClass + '">';
          html += '<td>' + (i + 1) + '</td>';
          html += '<td>' + escapeHtml(user.username) + '</td>';
          html += '<td>' + user.totalExams + '</td>';
          html += '<td>' + user.modulesAttempted + '</td>';
          html += '<td>' + user.sectionsAttempted + '</td>';
          html += '<td>' + user.bestScore + '%</td>';
          html += '<td>' + user.avgScore + '%</td>';
          html += '</tr>';
        }
        userStatsBody.innerHTML = html;
      }

      function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      async function loadLeaderboard() {
        contentEl.setAttribute('aria-busy', 'true');
        loadingEl.style.display = 'flex';

        try {
          // Fetch leaderboards grouped by individual exams
          leaderboardData = await Leaderboard.fetchAllLeaderboardsByExam();
          renderLeaderboard();
        } catch (error) {
          console.error('Failed to load leaderboard:', error);
          contentEl.innerHTML = '<p class="leaderboard-empty">Failed to load leaderboard data. Please try again later.</p>';
        } finally {
          loadingEl.style.display = 'none';
          contentEl.setAttribute('aria-busy', 'false');
        }
      }

      function renderLeaderboard() {
        var html = '';
        var config = Leaderboard.getConfig();
        var modules = config.modules;

        // Separate regular modules from practice exams
        var regularModules = [];
        var practiceExams = [];
        
        for (var i = 0; i < modules.length; i++) {
          if (modules[i].startsWith('PTP2E')) {
            practiceExams.push(modules[i]);
          } else {
            regularModules.push(modules[i]);
          }
        }

        // Render based on current filter
        if (currentFilter === 'all') {
          // Show all 4 module sections (section tests only, no practice exams)
          for (var i = 0; i < regularModules.length; i++) {
            var moduleId = regularModules[i];
            var examLeaderboards = leaderboardData[moduleId] || {};
            // Filter out practice exam (same ID as module)
            var sectionTestsOnly = {};
            for (var examId in examLeaderboards) {
              if (examId !== moduleId) {
                sectionTestsOnly[examId] = examLeaderboards[examId];
              }
            }
            html += Leaderboard.renderLeaderboardByExam(moduleId, sectionTestsOnly, true);
          }
          
          // Show separate practice exams section
          html += '<div class="leaderboard-section-divider"></div>';
          html += '<h2 class="leaderboard-section-title">Practice Exams</h2>';
          html += '<div class="leaderboard-module-group" data-module="practice-exams">';
          
          // Show all 4 practice exams (270201, 270202, 270203, 270204)
          for (var j = 0; j < regularModules.length; j++) {
            var moduleId = regularModules[j];
            var examLeaderboards = leaderboardData[moduleId] || {};
            var practiceExamData = examLeaderboards[moduleId] || [];
            
            html += '<div class="leaderboard-exam" data-exam="' + moduleId + '">';
            html += '<h4 class="leaderboard-exam-title">' + Leaderboard.getExamName(moduleId) + '</h4>';
            
            if (!practiceExamData || practiceExamData.length === 0) {
              html += '<p class="leaderboard-empty">No scores recorded yet. Be the first!</p>';
            } else {
              html += renderPracticeExamTable(practiceExamData, config.topN);
            }
            html += '</div>';
          }
          html += '</div>';
        } else if (currentFilter === 'practice') {
          // Show only practice exams section
          html += '<h2 class="leaderboard-section-title">Practice Exams</h2>';
          html += '<div class="leaderboard-module-group" data-module="practice-exams">';
          
          // Show all 4 practice exams
          for (var j = 0; j < regularModules.length; j++) {
            var moduleId = regularModules[j];
            var examLeaderboards = leaderboardData[moduleId] || {};
            var practiceExamData = examLeaderboards[moduleId] || [];
            
            html += '<div class="leaderboard-exam" data-exam="' + moduleId + '">';
            html += '<h4 class="leaderboard-exam-title">' + Leaderboard.getExamName(moduleId) + '</h4>';
            
            if (!practiceExamData || practiceExamData.length === 0) {
              html += '<p class="leaderboard-empty">No scores recorded yet. Be the first!</p>';
            } else {
              html += renderPracticeExamTable(practiceExamData, config.topN);
            }
            html += '</div>';
          }
          html += '</div>';
        } else {
          // Show specific module (section tests only, no practice exam)
          var examLeaderboards = leaderboardData[currentFilter] || {};
          var sectionTestsOnly = {};
          for (var examId in examLeaderboards) {
            if (examId !== currentFilter) {
              sectionTestsOnly[examId] = examLeaderboards[examId];
            }
          }
          html += Leaderboard.renderLeaderboardByExam(currentFilter, sectionTestsOnly, true);
        }

        if (!html) {
          html = '<p class="leaderboard-empty">No leaderboard data available for the selected module.</p>';
        }

        contentEl.innerHTML = html;
      }
      
      function renderPracticeExamTable(entries, topN) {
        var html = '<table class="leaderboard-table">';
        html += '<colgroup>';
        html += '<col class="col-rank">';
        html += '<col class="col-name">';
        html += '<col class="col-score">';
        html += '<col class="col-attempts">';
        html += '<col class="col-date">';
        html += '</colgroup>';
        html += '<thead><tr>';
        html += '<th class="leaderboard-rank">#</th>';
        html += '<th class="leaderboard-name">Name</th>';
        html += '<th class="leaderboard-score">Best Score</th>';
        html += '<th class="leaderboard-attempts">Attempts</th>';
        html += '<th class="leaderboard-date">Last Attempt</th>';
        html += '</tr></thead>';
        html += '<tbody>';
        
        for (var i = 0; i < Math.min(entries.length, topN); i++) {
          var entry = entries[i];
          if (!entry || typeof entry.username === 'undefined' || typeof entry.bestScore === 'undefined') {
            continue;
          }
          var rankClass = i < 3 ? 'rank-' + (i + 1) : '';
          html += '<tr class="leaderboard-row ' + rankClass + '">';
          html += '<td class="leaderboard-rank">' + (i + 1) + '</td>';
          html += '<td class="leaderboard-name">' + escapeHtml(entry.username) + '</td>';
          html += '<td class="leaderboard-score">' + entry.bestScore + '%</td>';
          html += '<td class="leaderboard-attempts">' + (entry.attemptsCount || 0) + '</td>';
          html += '<td class="leaderboard-date">' + Leaderboard.formatTimestamp(entry.lastAttempt) + '</td>';
          html += '</tr>';
        }
        
        html += '</tbody></table>';
        return html;
      }

    })();
  </script>
</body>
</html>
