<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Leaderboard - See the top scores for Parts Technician practice exams. Compete with other students!">
  <title>Leaderboard ‚Äì Second Period Practice Tests</title>
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="../assets/css/leaderboard.css">
  <link rel="stylesheet" href="../assets/css/leaderboard-fixes.css">
  
  <!-- Firebase Configuration and Integration -->
  <script src="../config/firebase.config.js"></script>
  <script src="../assets/js/leaderboard-firebase.js"></script>
  
  <script src="../assets/js/leaderboard.js"></script>
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-to-content">Skip to main content</a>

  <!-- Hero header -->
  <header class="site-header site-header--hero" role="banner">
    <div class="header-fog" aria-hidden="true"></div>
    <div class="header-particles" aria-hidden="true"></div>
    <div class="header-content">
      <p class="header-subtitle">Parts Technician ‚Ä¢ Second Period</p>
      <h1>Leaderboard</h1>
      <p>See top scores and compete with other students!</p>
    </div>
  </header>

  <main id="main-content" class="leaderboard-wrapper">
    <!-- Back link -->
    <div class="back-link">
      <a href="../index.html">‚Üê Back to main module selection</a>
    </div>

    <!-- Header section -->
    <section class="leaderboard-header" aria-labelledby="leaderboard-heading">
      <h2 id="leaderboard-heading">Top Scores by Module</h2>
      <p>
        Track your progress and see how you compare to other students.
        Set your display name below to have your scores recorded on the leaderboard.
      </p>
      <div class="leaderboard-status" id="leaderboard-status">
        <span class="status-dot"></span>
        <span id="status-text">Using sample data</span>
      </div>
    </section>

    <!-- Username section -->
    <section class="username-section" aria-labelledby="username-heading">
      <h3 id="username-heading">Your Display Name</h3>
      <form class="username-form" id="username-form">
        <input 
          type="text" 
          id="username-input" 
          class="username-input" 
          placeholder="Enter your display name"
          maxlength="30"
          autocomplete="off"
          aria-describedby="username-help"
        >
        <button type="submit" class="username-btn">Save Name</button>
      </form>
      <p class="username-current" id="username-current" aria-live="polite"></p>
      <p id="username-help" class="sr-only">
        Your display name will be shown on the leaderboard when you complete exams.
      </p>
    </section>

    <!-- Module tabs for filtering -->
    <nav class="leaderboard-tabs" aria-label="Module filter" id="module-tabs">
      <button class="leaderboard-tab active" data-module="all">All Modules</button>
      <button class="leaderboard-tab" data-module="270201">270201</button>
      <button class="leaderboard-tab" data-module="270202">270202</button>
      <button class="leaderboard-tab" data-module="270203">270203</button>
      <button class="leaderboard-tab" data-module="270204">270204</button>
    </nav>

    <!-- Leaderboard content -->
    <section id="leaderboard-content" aria-live="polite" aria-busy="false">
      <div class="leaderboard-loading" id="loading-indicator">
        <div class="spinner" aria-hidden="true"></div>
        <span>Loading leaderboard...</span>
      </div>
    </section>

    <!-- Tips section -->
    <aside class="tip-callout">
      <p>
        <strong>üí° Tip:</strong> Complete practice exams to appear on the leaderboard.
        Your best score per module is recorded. Keep practicing to improve your ranking!
      </p>
    </aside>
  </main>

  <footer class="site-footer" role="contentinfo">
    <span>Built for Parts Technician ‚Ä¢ Wolf Pack Training</span>
    <span>Leaderboard feature ‚Äì compete and track your progress!</span>
  </footer>

  <script>
    // Leaderboard page initialization
    ;(function() {
      'use strict';

      var currentFilter = 'all';
      var leaderboardData = {};

      // DOM elements
      var contentEl = document.getElementById('leaderboard-content');
      var loadingEl = document.getElementById('loading-indicator');
      var usernameForm = document.getElementById('username-form');
      var usernameInput = document.getElementById('username-input');
      var usernameCurrentEl = document.getElementById('username-current');
      var statusEl = document.getElementById('leaderboard-status');
      var statusTextEl = document.getElementById('status-text');
      var tabsEl = document.getElementById('module-tabs');

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', init);

      function init() {
        // Display current username
        updateUsernameDisplay();
        
        // Update backend status
        updateBackendStatus();
        
        // Load leaderboard data
        loadLeaderboard();
        
        // Set up event listeners
        setupEventListeners();
      }

      function setupEventListeners() {
        // Username form submission
        usernameForm.addEventListener('submit', function(e) {
          e.preventDefault();
          var newName = usernameInput.value.trim();
          if (newName) {
            Leaderboard.username(newName);
            updateUsernameDisplay();
            usernameInput.value = '';
          }
        });

        // Tab switching
        tabsEl.addEventListener('click', function(e) {
          var tab = e.target.closest('.leaderboard-tab');
          if (!tab) return;
          
          // Update active tab
          var allTabs = tabsEl.querySelectorAll('.leaderboard-tab');
          for (var i = 0; i < allTabs.length; i++) {
            allTabs[i].classList.remove('active');
          }
          tab.classList.add('active');
          
          // Update filter and re-render
          currentFilter = tab.getAttribute('data-module');
          renderLeaderboard();
        });
      }

      function updateUsernameDisplay() {
        var current = Leaderboard.username();
        if (current) {
          usernameCurrentEl.innerHTML = 'Current name: <strong>' + Leaderboard.escapeHtml(current) + '</strong>';
        } else {
          usernameCurrentEl.textContent = 'No display name set. Enter one above to track your scores.';
        }
      }

      async function updateBackendStatus() {
        var isConfigured = await Leaderboard.isBackendConfigured();
        if (isConfigured) {
          statusEl.classList.add('status-live');
          statusTextEl.textContent = 'Live data connected';
        } else {
          statusEl.classList.remove('status-live');
          statusTextEl.textContent = 'Using sample data (demo mode)';
        }
      }

      async function loadLeaderboard() {
        contentEl.setAttribute('aria-busy', 'true');
        loadingEl.style.display = 'flex';

        try {
          leaderboardData = await Leaderboard.fetchAllLeaderboards();
          renderLeaderboard();
        } catch (error) {
          console.error('Failed to load leaderboard:', error);
          contentEl.innerHTML = '<p class="leaderboard-empty">Failed to load leaderboard data. Please try again later.</p>';
        } finally {
          loadingEl.style.display = 'none';
          contentEl.setAttribute('aria-busy', 'false');
        }
      }

      function renderLeaderboard() {
        var html = '';
        var config = Leaderboard.getConfig();
        var modules = config.modules;

        for (var i = 0; i < modules.length; i++) {
          var moduleId = modules[i];
          
          // Skip if filtering by specific module and this isn't it
          if (currentFilter !== 'all' && currentFilter !== moduleId) {
            continue;
          }

          var entries = leaderboardData[moduleId] || [];
          html += Leaderboard.renderLeaderboardTable(moduleId, entries);
        }

        if (!html) {
          html = '<p class="leaderboard-empty">No leaderboard data available for the selected module.</p>';
        }

        contentEl.innerHTML = html;
      }

    })();
  </script>
</body>
</html>
