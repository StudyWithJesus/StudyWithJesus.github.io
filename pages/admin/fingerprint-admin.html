<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Fingerprint Admin Dashboard</title>
  <!-- GitHub OAuth Configuration -->
  <script>
    window.GITHUB_CLIENT_ID = ''; // Will be set via environment or config
  </script>
  <script src="../../assets/js/github-auth.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
    }

    .auth-section {
      padding: 40px;
      text-align: center;
      background: #f8f9fa;
    }

    .auth-section input {
      padding: 12px 20px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 6px;
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
    }

    .auth-section button {
      padding: 12px 30px;
      font-size: 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 5px;
    }

    .auth-section button:hover {
      background: #5568d3;
    }

    .main-content {
      padding: 30px;
      display: none;
    }

    .main-content.active {
      display: block;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 2rem;
      margin-bottom: 5px;
    }

    .stat-card p {
      opacity: 0.9;
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      align-items: center;
    }

    .controls input {
      flex: 1;
      min-width: 250px;
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .controls button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .controls button:hover {
      background: #5568d3;
    }

    .controls button.danger {
      background: #dc3545;
    }

    .controls button.danger:hover {
      background: #c82333;
    }

    .fingerprint-list {
      background: #f8f9fa;
      border-radius: 8px;
      overflow: hidden;
    }

    .fingerprint-item {
      background: white;
      border-bottom: 1px solid #e9ecef;
      padding: 20px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 20px;
      align-items: center;
      transition: all 0.2s;
    }

    .fingerprint-item:hover {
      background: #f8f9fa;
    }

    .fingerprint-item.blocked {
      background: #ffe6e6;
    }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
      background: #ccc;
      border-radius: 30px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: #dc3545;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 26px;
      height: 26px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }

    .toggle-switch.active::after {
      transform: translateX(30px);
    }

    .fingerprint-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .fingerprint-info .name {
      font-weight: 600;
      font-size: 1.1rem;
      color: #333;
    }

    .fingerprint-info .hash {
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.85rem;
      color: #666;
      word-break: break-all;
    }

    .fingerprint-info .meta {
      font-size: 0.85rem;
      color: #999;
    }

    .toggle-label {
      font-weight: 600;
      color: #666;
      min-width: 80px;
      text-align: center;
    }

    .toggle-label.blocked {
      color: #dc3545;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .alert {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .alert.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîí Fingerprint Admin Dashboard</h1>
      <p>Manage and control access via fingerprint whitelist</p>
      <button class="logout-btn" onclick="logout()" style="display: none;" id="logout-btn">Logout</button>
    </div>

    <!-- Authentication Section -->
    <div class="auth-section" id="auth-section">
      <!-- Will be populated by GitHub Auth -->
    </div>

    <!-- Main Dashboard Content -->
    <div class="main-content" id="main-content" style="display: none;">
      <!-- Stats Section -->
      <div class="stats">
        <div class="stat-card">
          <h3 id="total-fingerprints">0</h3>
          <p>Total Fingerprints</p>
        </div>
        <div class="stat-card">
          <h3 id="blocked-fingerprints">0</h3>
          <p>Blocked</p>
        </div>
        <div class="stat-card">
          <h3 id="allowed-fingerprints">0</h3>
          <p>Allowed</p>
        </div>
      </div>

      <!-- Alert Box -->
      <div class="alert info">
        <strong>‚ÑπÔ∏è How it works:</strong> Toggle the switch next to a fingerprint to block or allow access. 
        Blocked fingerprints are added to the whitelist blocker. Changes are saved automatically.
      </div>

      <!-- Controls -->
      <div class="controls">
        <input 
          type="text" 
          id="search-input" 
          placeholder="Search by name or fingerprint hash..."
          oninput="filterFingerprints()"
        >
        <button onclick="refreshData()">üîÑ Refresh</button>
        <button onclick="exportWhitelist()">üì• Export Whitelist</button>
        <button onclick="clearAllBlocks()" class="danger">üóëÔ∏è Clear All Blocks</button>
      </div>

      <!-- Fingerprint List -->
      <div class="fingerprint-list" id="fingerprint-list">
        <!-- Will be populated dynamically -->
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const STORAGE_KEY_BLOCKED = 'fingerprint_blocked_list';
    const STORAGE_KEY_FINGERPRINTS = 'fingerprint_logs';
    
    // State
    let fingerprintData = [];
    let blockedFingerprints = new Set();
    let currentUser = null;

    /**
     * Show dashboard
     */
    function showDashboard(user) {
      currentUser = user;
      document.getElementById('auth-section').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      
      // Show user info in header
      showUserInfo(user);
      
      loadData();
    }
    
    /**
     * Show user info in header
     */
    function showUserInfo(user) {
      const header = document.querySelector('.header');
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) logoutBtn.remove();
      
      const userInfo = document.createElement('button');
      userInfo.id = 'logout-btn';
      userInfo.className = 'logout-btn';
      userInfo.onclick = () => GitHubAuth.logout();
      userInfo.style.display = 'flex';
      userInfo.style.alignItems = 'center';
      userInfo.style.gap = '8px';
      userInfo.innerHTML = `
        <img src="${user.avatar}" alt="${user.username}" style="width: 24px; height: 24px; border-radius: 50%;">
        <span>${user.username}</span>
      `;
      header.appendChild(userInfo);
    }

    /**
     * Load data from localStorage and GitHub issues simulation
     */
    function loadData() {
      // Load blocked list
      const blockedList = localStorage.getItem(STORAGE_KEY_BLOCKED);
      blockedFingerprints = new Set(blockedList ? JSON.parse(blockedList) : []);

      // Load fingerprint logs (normally would fetch from GitHub issues)
      // For now, we'll create a mock based on current fingerprint + username
      fingerprintData = loadFingerprintLogs();

      updateStats();
      renderFingerprints();
    }

    /**
     * Load fingerprint logs
     * In production, this would fetch from GitHub issues API
     */
    function loadFingerprintLogs() {
      const logs = localStorage.getItem(STORAGE_KEY_FINGERPRINTS);
      let data = logs ? JSON.parse(logs) : [];

      // If no logs, create current user's fingerprint
      if (data.length === 0) {
        const username = localStorage.getItem('leaderboard_username') || 'Guest';
        const currentFp = generateCurrentFingerprint();
        
        data.push({
          id: Date.now(),
          name: username,
          fingerprint: currentFp,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          lastSeen: new Date().toISOString()
        });

        localStorage.setItem(STORAGE_KEY_FINGERPRINTS, JSON.stringify(data));
      }

      return data;
    }

    /**
     * Generate current browser fingerprint (sync version for demo)
     */
    function generateCurrentFingerprint() {
      const data = [
        navigator.userAgent || '',
        navigator.language || '',
        navigator.hardwareConcurrency || '',
        navigator.deviceMemory || '',
        navigator.platform || '',
        screen.width + 'x' + screen.height,
        screen.colorDepth || '',
        new Date().getTimezoneOffset(),
        !!window.sessionStorage,
        !!window.localStorage,
        !!window.indexedDB,
        navigator.cookieEnabled
      ].join('|');
      
      // Simple hash for demo (in production, use crypto.subtle.digest)
      let hash = 0;
      for (let i = 0; i < data.length; i++) {
        const char = data.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash).toString(16).padStart(64, '0').substring(0, 64);
    }

    /**
     * Update statistics
     */
    function updateStats() {
      const total = fingerprintData.length;
      const blocked = fingerprintData.filter(fp => blockedFingerprints.has(fp.fingerprint)).length;
      const allowed = total - blocked;

      document.getElementById('total-fingerprints').textContent = total;
      document.getElementById('blocked-fingerprints').textContent = blocked;
      document.getElementById('allowed-fingerprints').textContent = allowed;
    }

    /**
     * Render fingerprints
     */
    function renderFingerprints() {
      const listEl = document.getElementById('fingerprint-list');
      const searchTerm = document.getElementById('search-input').value.toLowerCase();

      const filtered = fingerprintData.filter(fp => 
        fp.name.toLowerCase().includes(searchTerm) || 
        fp.fingerprint.toLowerCase().includes(searchTerm)
      );

      if (filtered.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <h3>No fingerprints found</h3>
            <p>Fingerprints will appear here as users visit the site</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = filtered.map(fp => {
        const isBlocked = blockedFingerprints.has(fp.fingerprint);
        const itemClass = isBlocked ? 'fingerprint-item blocked' : 'fingerprint-item';
        const toggleClass = isBlocked ? 'toggle-switch active' : 'toggle-switch';
        const labelClass = isBlocked ? 'toggle-label blocked' : 'toggle-label';
        const labelText = isBlocked ? 'BLOCKED' : 'Allowed';

        return `
          <div class="${itemClass}">
            <div 
              class="${toggleClass}" 
              onclick="toggleBlock('${fp.fingerprint}')"
              title="Click to ${isBlocked ? 'allow' : 'block'}"
            ></div>
            <div class="fingerprint-info">
              <div class="name">${escapeHtml(fp.name)}</div>
              <div class="hash">${fp.fingerprint}</div>
              <div class="meta">
                Last seen: ${new Date(fp.lastSeen).toLocaleString()} ‚Ä¢ 
                First seen: ${new Date(fp.timestamp).toLocaleString()}
              </div>
            </div>
            <div class="${labelClass}">${labelText}</div>
          </div>
        `;
      }).join('');
    }

    /**
     * Toggle block status
     */
    function toggleBlock(fingerprint) {
      if (blockedFingerprints.has(fingerprint)) {
        blockedFingerprints.delete(fingerprint);
      } else {
        blockedFingerprints.add(fingerprint);
      }

      // Save to localStorage
      localStorage.setItem(STORAGE_KEY_BLOCKED, JSON.stringify([...blockedFingerprints]));

      // Update UI
      updateStats();
      renderFingerprints();

      // Update the whitelist file configuration
      updateWhitelistFile();
    }

    /**
     * Update whitelist file configuration
     * Shows instructions for updating the whitelist-fingerprint.js file
     */
    function updateWhitelistFile() {
      console.log('Blocked fingerprints:', [...blockedFingerprints]);
      console.log('Copy these fingerprints to assets/whitelist-fingerprint.js');
    }

    /**
     * Filter fingerprints
     */
    function filterFingerprints() {
      renderFingerprints();
    }

    /**
     * Refresh data
     */
    function refreshData() {
      loadData();
      alert('‚úÖ Data refreshed successfully!');
    }

    /**
     * Export whitelist configuration
     */
    function exportWhitelist() {
      const allowed = fingerprintData
        .filter(fp => !blockedFingerprints.has(fp.fingerprint))
        .map(fp => `  '${fp.fingerprint}', // ${fp.name}`);

      const config = `// Whitelist Configuration
// Generated: ${new Date().toISOString()}
// Copy this array to assets/whitelist-fingerprint.js

const allowedFingerprints = [
${allowed.join('\n')}
];

// Note: When this array is NOT empty, only these fingerprints can access the site.
// To disable blocking, keep the array empty: const allowedFingerprints = [];`;

      // Copy to clipboard
      navigator.clipboard.writeText(config).then(() => {
        alert('‚úÖ Whitelist configuration copied to clipboard!\n\nPaste this into assets/whitelist-fingerprint.js');
      }).catch(() => {
        // Fallback: show in alert
        prompt('Copy this whitelist configuration:', config);
      });
    }

    /**
     * Clear all blocks
     */
    function clearAllBlocks() {
      if (confirm('Are you sure you want to allow all fingerprints?')) {
        blockedFingerprints.clear();
        localStorage.setItem(STORAGE_KEY_BLOCKED, JSON.stringify([]));
        updateStats();
        renderFingerprints();
        alert('‚úÖ All blocks cleared!');
      }
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * Initialize
     */
    function init() {
      // Check GitHub authentication
      GitHubAuth.requireAuth().then(user => {
        // User is authenticated - show dashboard
        showDashboard(user);
      }).catch(err => {
        // Not authenticated - show login UI
        document.getElementById('main-content').style.display = 'none';
        GitHubAuth.showAuthUI('auth-section');
      });
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
