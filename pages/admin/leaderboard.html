<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="description" content="Admin Leaderboard - View detailed user statistics and exam attempts.">
  <title>Admin ‚Äì Leaderboard Statistics</title>
  <link rel="stylesheet" href="../../style.css">
  <link rel="stylesheet" href="../../assets/css/leaderboard.css">
  <link rel="stylesheet" href="../../assets/css/admin-responsive.css">
  
  <!-- GitHub OAuth Configuration -->
  <script src="../../config/github-oauth.config.js"></script>
  <script src="../../assets/js/github-auth.js"></script>
  
  <!-- Firebase Configuration and Integration -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="../../config/firebase.config.js"></script>
  <script src="../../assets/js/leaderboard-firebase.js"></script>
  
  <script src="../../assets/js/leaderboard.js"></script>
  <style>
    /* Admin back button styling to match Admin Hub */
    .admin-wrapper > .back-link {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      margin-bottom: 0;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .admin-wrapper > .back-link a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      transition: background 0.3s;
      font-size: 0.95rem;
    }

    .admin-wrapper > .back-link a:hover {
      background: rgba(255, 255, 255, 0.3);
      color: white;
    }
    
    /* Delete button styling */
    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.2s;
    }
    
    .delete-btn:hover {
      background: #c82333;
    }
    
    .delete-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-to-content">Skip to main content</a>

  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="header-fog" aria-hidden="true"></div>
    <div class="header-particles" aria-hidden="true"></div>
    <div class="header-content">
      <p class="header-subtitle">Admin Panel</p>
      <h1>Leaderboard Administration</h1>
      <p>View user statistics, exam counts, and detailed attempt history.</p>
    </div>
  </header>

  <main id="main-content" class="admin-wrapper">
    <!-- Back link -->
    <div class="back-link">
      <a href="index.html">‚Üê Back to Admin Hub</a>
      <a href="../../index.html">‚Üê Back to Main Site</a>
    </div>

    <!-- Admin header -->
    <header class="admin-header">
      <h2>User Statistics Dashboard</h2>
      <p>Review per-user exam counts, module performance, and detailed attempt logs.</p>
    </header>

    <!-- Access control section -->
    <section id="access-section" aria-labelledby="access-heading">
      
      <!-- GitHub OAuth Authentication Section -->
      <div id="github-auth-section"></div>

      <!-- Access denied message (shown when no valid access) -->
      <div class="admin-access-denied" id="access-denied" style="display: none;">
        <h3 id="access-heading">Admin Access Required</h3>
        <p>
          This page requires admin authentication via GitHub OAuth.
        </p>
        <p style="margin-top: var(--space-3);">
          Only the authorized GitHub account can access this page.
        </p>
      </div>

    </section>

    <!-- Admin content (hidden until authenticated) -->
    <div id="admin-content" style="display: none;">
      
      <!-- Summary stats -->
      <section class="admin-section" aria-labelledby="stats-heading">
        <h3 id="stats-heading">Overview Statistics</h3>
        <div class="admin-stats-grid" id="stats-grid">
          <div class="admin-stat-card">
            <h4>Total Users</h4>
            <div class="admin-stat-value" id="stat-users">-</div>
          </div>
          <div class="admin-stat-card">
            <h4>Total Exams Taken</h4>
            <div class="admin-stat-value" id="stat-exams">-</div>
          </div>
          <div class="admin-stat-card">
            <h4>Average Score</h4>
            <div class="admin-stat-value" id="stat-avg-score">-</div>
          </div>
          <div class="admin-stat-card">
            <h4>Data Source</h4>
            <div class="admin-stat-value" id="stat-source" style="font-size: var(--font-size-base);">Sample</div>
          </div>
        </div>
      </section>

      <!-- Per-user stats table -->
      <section class="admin-section" aria-labelledby="users-heading">
        <h3 id="users-heading">Per-User Statistics</h3>
        <div id="users-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Total Exams</th>
                <th>Modules Attempted</th>
                <th>Best Score</th>
                <th>Avg Score</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <tr>
                <td colspan="5" style="text-align: center; padding: var(--space-6);">
                  Loading user data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Attempt history -->
      <section class="admin-section" aria-labelledby="history-heading">
        <h3 id="history-heading">Recent Attempt History</h3>
        <div id="history-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Module</th>
                <th>Exam</th>
                <th>Score</th>
                <th>Timestamp</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="history-table-body">
              <tr>
                <td colspan="6" style="text-align: center; padding: var(--space-6);">
                  Loading attempt history...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="admin-pagination" id="history-pagination">
          <button id="prev-page" disabled>‚Üê Previous</button>
          <button id="next-page" disabled>Next ‚Üí</button>
        </div>
      </section>

      <!-- Security notice -->
      <aside class="security-notice">
        <h4>üîí Security & Audit Logging</h4>
        <p>
          <strong>‚úÖ Audit Logging Active:</strong> All admin access and actions are automatically logged to 
          Firestore (<code>admin_logs</code> collection) with timestamps, user information, and action metadata.
        </p>
        <p style="margin-top: var(--space-2);">
          <strong>Logged Actions:</strong> Dashboard views, data reads, test result deletions, and fingerprint blocks 
          are tracked for security and compliance purposes.
        </p>
      </aside>
    </div>

  </main>

  <footer class="site-footer" role="contentinfo">
    <span>Admin Panel ‚Ä¢ Leaderboard Statistics</span>
    <span>Access restricted to authorized administrators</span>
  </footer>

  <script>
    // Admin page initialization
    ;(function() {
      'use strict';

      // Configuration - GitHub OAuth Only
      var isAuthenticated = false;
      var adminData = null;
      var currentUser = null;

      // DOM elements
      var accessDeniedEl = document.getElementById('access-denied');
      var githubAuthSectionEl = document.getElementById('github-auth-section');
      var adminContentEl = document.getElementById('admin-content');
      var usersTableBody = document.getElementById('users-table-body');
      var historyTableBody = document.getElementById('history-table-body');

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', init);

      function init() {
        console.log('=== Admin Leaderboard Initialization ===');
        
        // Log access attempt (for local auditing)
        logAdminAccess('Page loaded');

        // Check access - GitHub OAuth only
        checkAccess();
        
        // Set up event listeners
        setupEventListeners();
        
        // Listen for successful login events
        window.addEventListener('githubauth:login', function(event) {
          console.log('Login event received, refreshing UI...', event);
          // Re-check access to show authenticated content
          checkAccess();
        });
      }

      function setupEventListeners() {
        // Pagination
        document.getElementById('prev-page').addEventListener('click', function() {
          // Pagination would be implemented with actual backend
          console.log('Previous page');
        });
        document.getElementById('next-page').addEventListener('click', function() {
          console.log('Next page');
        });
      }

      async function checkAccess() {
        console.log('checkAccess() called');
        
        // Check if GitHub Auth is available
        if (!window.GitHubAuth) {
          console.error('GitHub Auth module not loaded');
          accessDeniedEl.style.display = 'block';
          return;
        }
        
        console.log('GitHub Auth module found');
        
        // Require GitHub OAuth authentication only
        try {
          console.log('Attempting to require auth...');
          var user = await GitHubAuth.requireAuth();
          // User is authenticated via GitHub OAuth
          console.log('User authenticated:', user);
          currentUser = user;
          logAdminAccess('Authenticated via GitHub: ' + user.username);
          showUserInfo(user);
          grantAccess();
        } catch (err) {
          // Not authenticated - show login UI
          console.log('Auth failed, showing login UI:', err);
          if (githubAuthSectionEl) {
            await GitHubAuth.showAuthUI('github-auth-section');
          } else {
            console.error('github-auth-section element not found');
            accessDeniedEl.style.display = 'block';
          }
        }
      }
      
      function showUserInfo(user) {
        // Add user info to header
        var header = document.querySelector('.admin-header');
        if (header && user) {
          var userInfo = document.createElement('div');
          userInfo.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px;';
          
          // Create elements safely to prevent XSS
          var img = document.createElement('img');
          // Validate avatar URL is from trusted sources only
          var defaultAvatar = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><circle cx="16" cy="16" r="16" fill="%23ccc"/></svg>';
          
          if (user.avatar) {
            // Only allow HTTPS URLs from trusted domains
            var trustedDomains = [
              'https://avatars.githubusercontent.com/',
              'https://lh3.googleusercontent.com/',
              'https://graph.facebook.com/',
              'https://platform-lookaside.fbsbx.com/'
            ];
            
            var isTrusted = trustedDomains.some(function(domain) {
              return user.avatar.startsWith(domain);
            });
            
            if (isTrusted) {
              img.src = user.avatar;
            } else {
              console.warn('Untrusted avatar URL, using default:', user.avatar);
              img.src = defaultAvatar;
            }
          } else {
            img.src = defaultAvatar;
          }
          img.alt = 'User avatar';
          img.style.cssText = 'width: 32px; height: 32px; border-radius: 50%;';
          
          var userDetails = document.createElement('div');
          userDetails.style.cssText = 'flex: 1;';
          
          var authText = document.createElement('div');
          authText.style.fontWeight = '600';
          // Sanitize username - only allow alphanumeric, dash, and underscore (GitHub username rules)
          var safeUsername = (user.username || 'Unknown').replace(/[^a-zA-Z0-9-_]/g, '');
          authText.textContent = 'Authenticated as ' + safeUsername;
          
          var oauthLabel = document.createElement('div');
          oauthLabel.style.cssText = 'font-size: 0.9rem; opacity: 0.8;';
          oauthLabel.textContent = 'GitHub via Firebase';
          
          var logoutBtn = document.createElement('button');
          logoutBtn.textContent = 'Logout';
          logoutBtn.style.cssText = 'padding: 6px 12px; background: var(--color-accent); color: white; border: none; border-radius: 4px; cursor: pointer;';
          logoutBtn.onclick = function() { GitHubAuth.logout(); };
          
          userDetails.appendChild(authText);
          userDetails.appendChild(oauthLabel);
          userInfo.appendChild(img);
          userInfo.appendChild(userDetails);
          userInfo.appendChild(logoutBtn);
          header.appendChild(userInfo);
        }
      }

      async function grantAccess() {
        console.log('grantAccess() called');
        
        isAuthenticated = true;
        accessDeniedEl.style.display = 'none';
        adminContentEl.style.display = 'block';
        
        console.log('Admin content displayed');
        
        // Log admin access to Firestore
        logAdminAccessToFirestore('leaderboard_dashboard_view');
        
        // Wait a moment for Firebase auth to fully initialize
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // Load admin data
        console.log('Calling loadAdminData()...');
        loadAdminData();
      }

      async function loadAdminData() {
        console.log('loadAdminData() called');
        
        // Check if Firebase admin functions are available
        try {
          if (window.LeaderboardFirebase) {
            console.log('LeaderboardFirebase module found, checking admin status...');
            const adminStatus = await window.LeaderboardFirebase.isAdmin();
            console.log('Admin status check result:', adminStatus);
            
            if (adminStatus) {
              // Load from Firebase
              console.log('User is admin, loading Firebase data...');
              await loadFirebaseAdminData();
              return;
            } else {
              console.warn('User is not admin, loading sample data');
            }
          } else {
            console.warn('LeaderboardFirebase module not loaded');
          }
        } catch (error) {
          console.error('Error checking admin status:', error);
        }
        
        // Load sample data for demo
        console.log('Loading sample data...');
        loadSampleAdminData();
      }
        // Load sample data for demo
        loadSampleAdminData();
      }

      async function loadFirebaseAdminData() {
        try {
          console.log('Loading Firebase admin data...');
          
          // Log data access attempt
          logAdminAccessToFirestore('leaderboard_data_read', { action: 'loading' });
          
          // Load ALL attempts from Firestore (not just stats)
          const attempts = await window.LeaderboardFirebase.getAllAttempts();
          
          console.log('Loaded attempts:', attempts.length, 'total');
          
          // Aggregate user stats from attempts
          const userStats = aggregateUserStats(attempts);
          
          console.log('Aggregated user stats:', userStats);
          
          // Log successful data access
          logAdminAccessToFirestore('leaderboard_data_read', { 
            action: 'success',
            userCount: userStats.length,
            attemptCount: attempts.length
          });
          
          document.getElementById('stat-source').textContent = 'Live';
          renderAdminData(userStats, attempts);
        } catch (error) {
          console.error('Failed to load admin data:', error);
          
          // Log failed access
          logAdminAccessToFirestore('leaderboard_data_read', { 
            action: 'failed',
            error: error.message
          });
          
          alert('Failed to load Firebase data: ' + error.message + '\n\nLoading sample data instead.');
          loadSampleAdminData();
        }
      }
      
      function aggregateUserStats(attempts) {
        const userMap = {};
        
        attempts.forEach(function(attempt) {
          const username = attempt.username || 'Unknown';
          
          if (!userMap[username]) {
            userMap[username] = {
              username: username,
              totalExams: 0,
              moduleBreakdown: {}
            };
          }
          
          userMap[username].totalExams++;
          
          const moduleId = attempt.moduleId || 'unknown';
          if (!userMap[username].moduleBreakdown[moduleId]) {
            userMap[username].moduleBreakdown[moduleId] = {
              attempts: 0,
              totalScore: 0,
              averageScore: 0
            };
          }
          
          const breakdown = userMap[username].moduleBreakdown[moduleId];
          breakdown.attempts++;
          breakdown.totalScore += attempt.score || 0;
          breakdown.averageScore = Math.round(breakdown.totalScore / breakdown.attempts);
        });
        
        return Object.values(userMap);
      }

      async function loadSampleAdminData() {
        // Load sample data for demo/preview
        var basePath = getBasePath();
        
        console.log('Loading sample data from:', basePath + 'assets/data/leaderboard-sample.json');
        
        try {
          var response = await fetch(basePath + 'assets/data/leaderboard-sample.json');
          
          if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
          }
          
          var data = await response.json();
          
          console.log('Sample data loaded successfully:', data);
          
          if (!data.adminData || !data.adminData.userStats || !data.adminData.attemptHistory) {
            throw new Error('Invalid sample data structure');
          }
          
          document.getElementById('stat-source').textContent = 'Sample';
          renderAdminData(data.adminData.userStats, data.adminData.attemptHistory);
        } catch (error) {
          console.error('Failed to load sample data:', error);
          alert('Failed to load leaderboard data: ' + error.message);
          usersTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">Failed to load data: ' + error.message + '</td></tr>';
          historyTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">Failed to load data: ' + error.message + '</td></tr>';
        }
      }

      function renderAdminData(userStats, attemptHistory) {
        console.log('renderAdminData() called with:', { userStats, attemptHistory });
        
        // Calculate summary stats
        var totalUsers = userStats.length;
        var totalExams = 0;
        var totalScore = 0;
        var scoreCount = 0;

        for (var i = 0; i < userStats.length; i++) {
          totalExams += userStats[i].totalExams;
          var breakdown = userStats[i].moduleBreakdown;
          for (var moduleId in breakdown) {
            if (breakdown.hasOwnProperty(moduleId)) {
              totalScore += breakdown[moduleId].averageScore * breakdown[moduleId].attempts;
              scoreCount += breakdown[moduleId].attempts;
            }
          }
        }

        document.getElementById('stat-users').textContent = totalUsers;
        document.getElementById('stat-exams').textContent = totalExams;
        document.getElementById('stat-avg-score').textContent = scoreCount > 0 
          ? Math.round(totalScore / scoreCount) + '%' 
          : '-';

        console.log('Summary stats calculated:', { totalUsers, totalExams, avgScore: scoreCount > 0 ? Math.round(totalScore / scoreCount) : 0 });

        // Render users table
        renderUsersTable(userStats);

        // Render attempt history
        renderHistoryTable(attemptHistory);
      }

      function renderUsersTable(userStats) {
        if (!userStats || userStats.length === 0) {
          usersTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No user data available</td></tr>';
          return;
        }

        var html = '';
        for (var i = 0; i < userStats.length; i++) {
          var user = userStats[i];
          var breakdown = user.moduleBreakdown;
          var moduleCount = Object.keys(breakdown).length;
          
          var bestScore = 0;
          var totalScore = 0;
          var attemptCount = 0;
          
          for (var moduleId in breakdown) {
            if (breakdown.hasOwnProperty(moduleId)) {
              if (breakdown[moduleId].bestScore > bestScore) {
                bestScore = breakdown[moduleId].bestScore;
              }
              totalScore += breakdown[moduleId].averageScore;
              attemptCount++;
            }
          }
          
          var avgScore = attemptCount > 0 ? Math.round(totalScore / attemptCount) : 0;
          
          html += '<tr>';
          html += '<td>' + escapeHtml(user.username) + '</td>';
          html += '<td>' + user.totalExams + '</td>';
          html += '<td>' + moduleCount + '</td>';
          html += '<td>' + bestScore + '%</td>';
          html += '<td>' + avgScore + '%</td>';
          html += '</tr>';
        }
        
        usersTableBody.innerHTML = html;
      }

      function renderHistoryTable(attemptHistory) {
        if (!attemptHistory || attemptHistory.length === 0) {
          historyTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No attempt history available</td></tr>';
          return;
        }

        var html = '';
        for (var i = 0; i < attemptHistory.length; i++) {
          var attempt = attemptHistory[i];
          // Use Firebase document ID if available, otherwise create composite ID
          var attemptId = attempt.id || (attempt.username + '|' + attempt.moduleId + '|' + attempt.examId + '|' + attempt.timestamp);
          
          html += '<tr data-attempt-id="' + escapeHtml(attemptId) + '" data-has-doc-id="' + (!!attempt.id) + '">';
          html += '<td>' + escapeHtml(attempt.username || 'Unknown') + '</td>';
          html += '<td>' + escapeHtml(attempt.moduleId || 'unknown') + '</td>';
          html += '<td>' + escapeHtml(attempt.examId || 'unknown') + '</td>';
          html += '<td>' + (attempt.score || 0) + '%</td>';
          html += '<td>' + formatTimestamp(attempt.timestamp) + '</td>';
          html += '<td><button class="delete-btn" data-attempt-id="' + escapeHtml(attemptId) + '" data-has-doc-id="' + (!!attempt.id) + '">Delete</button></td>';
          html += '</tr>';
        }
        
        historyTableBody.innerHTML = html;
        
        // Add event delegation for delete buttons
        addDeleteButtonHandlers();
      }
      
      function addDeleteButtonHandlers() {
        var deleteButtons = document.querySelectorAll('.delete-btn');
        for (var i = 0; i < deleteButtons.length; i++) {
          deleteButtons[i].addEventListener('click', function(e) {
            var attemptId = this.getAttribute('data-attempt-id');
            if (attemptId) {
              deleteAttempt(attemptId);
            }
          });
        }
      }

      function logAdminAccess(action) {
        var logEntry = {
          timestamp: new Date().toISOString(),
          action: action,
          userAgent: navigator.userAgent,
          url: window.location.href
        };
        
        console.log('[ADMIN ACCESS LOG]', logEntry);
        
        // In production, this should be sent to a server-side logging service
        // For now, we just log to console and could optionally store locally
        try {
          var logs = JSON.parse(localStorage.getItem('admin_access_log') || '[]');
          logs.push(logEntry);
          // Keep only last 100 entries
          if (logs.length > 100) {
            logs = logs.slice(-100);
          }
          localStorage.setItem('admin_access_log', JSON.stringify(logs));
        } catch (e) {
          // localStorage may be unavailable
        }
      }
      
      // Delete attempt function (called via event delegation)
      async function deleteAttempt(attemptId) {
        if (!confirm('Are you sure you want to delete this test result? This action cannot be undone.')) {
          return;
        }
        
        // Get the button that was clicked to check if it has a doc ID
        var button = document.querySelector('.delete-btn[data-attempt-id="' + attemptId.replace(/"/g, '\\"') + '"]');
        var hasDocId = button && button.getAttribute('data-has-doc-id') === 'true';
        
        console.log('Delete attempt:', attemptId, 'hasDocId:', hasDocId);
        
        try {
          // Check if using Firebase
          if (window.LeaderboardFirebase && await window.LeaderboardFirebase.isAdmin()) {
            var success;
            
            if (hasDocId) {
              // Use document ID directly for deletion
              console.log('Deleting by document ID:', attemptId);
              success = await window.LeaderboardFirebase.deleteAttemptById(attemptId);
            } else {
              // Parse composite attemptId back to its components
              var parts = attemptId.split('|');
              if (parts.length !== 4) {
                alert('Error: Invalid attempt ID');
                return;
              }
              
              var username = parts[0];
              var moduleId = parts[1];
              var examId = parts[2];
              var timestamp = parts[3];
              
              console.log('Deleting by properties:', { username, moduleId, examId, timestamp });
              success = await window.LeaderboardFirebase.deleteAttempt(username, moduleId, examId, timestamp);
            }
            
            if (!success) {
              console.error('Delete failed for:', attemptId);
              alert('‚ùå Failed to delete from Firebase.\n\nPossible reasons:\n‚Ä¢ The record may not exist\n‚Ä¢ Timestamp format mismatch\n‚Ä¢ Database connectivity issue\n\nCheck browser console for details.');
              return;
            }
            
            // Log the deletion
            logAdminAccess('Deleted test result: ' + attemptId);
            logAdminAccessToFirestore('leaderboard_delete_attempt', { attemptId });
            
            // Remove the row from UI
            var row = button.closest('tr');
            if (row) {
              row.remove();
              alert('‚úÖ Test result deleted successfully!');
            }
          } else {
            alert('‚ö†Ô∏è Admin access required or Firebase not initialized.');
          }
        } catch (error) {
          console.error('Error deleting attempt:', error);
          alert('‚ùå Error deleting test result: ' + error.message);
        }
      }
          }
          
          // Reload data to refresh statistics
          loadAdminData();
          
          alert('‚úÖ Test result deleted successfully!');
        } catch (error) {
          console.error('Error deleting attempt:', error);
          alert('‚ùå Error deleting test result: ' + error.message);
        }
      }

      function getBasePath() {
        var path = window.location.pathname;
        var parts = path.split('/').filter(function(p) { return p && !p.includes('.html'); });
        if (parts.length === 0) return '';
        return '../'.repeat(parts.length);
      }

      function escapeHtml(str) {
        if (!str) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function formatTimestamp(isoString) {
        try {
          var date = new Date(isoString);
          return date.toLocaleDateString(undefined, {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch (e) {
          return 'Unknown';
        }
      }
      
      /**
       * Log admin access to Firestore for audit trail
       * @param {string} action - Action being performed
       * @param {Object} metadata - Additional metadata
       */
      async function logAdminAccessToFirestore(action, metadata = {}) {
        if (!currentUser) return;
        
        try {
          // Initialize Firebase if needed
          if (!firebase.apps || firebase.apps.length === 0) {
            if (!window.FIREBASE_CONFIG) return;
            firebase.initializeApp(window.FIREBASE_CONFIG);
          }
          
          var db = firebase.firestore();
          
          await db.collection('admin_logs').add({
            userId: currentUser.uid || 'unknown',
            username: currentUser.username || currentUser.displayName || 'unknown',
            email: currentUser.email || null,
            action: action,
            page: 'leaderboard_admin',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            metadata: metadata,
            userAgent: navigator.userAgent,
            url: window.location.href
          });
          
          console.log('Audit log: ' + action + ' by ' + currentUser.username);
        } catch (error) {
          // Silent failure - don't disrupt admin functionality
          console.warn('Failed to log admin access:', error);
        }
      }

    })();
  </script>
</body>
</html>
