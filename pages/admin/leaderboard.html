<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="description" content="Admin Leaderboard - View detailed user statistics and exam attempts.">
  <title>Admin ‚Äì Leaderboard Statistics</title>
  <link rel="stylesheet" href="../../style.css">
  <link rel="stylesheet" href="../../assets/css/leaderboard.css">
  
  <!-- GitHub OAuth Configuration -->
  <script src="../../config/github-oauth.config.js"></script>
  <script src="../../assets/js/github-auth.js"></script>
  
  <!-- Firebase Configuration and Integration -->
  <script src="../../config/firebase.config.js"></script>
  <script src="../../assets/js/leaderboard-firebase.js"></script>
  
  <script src="../../assets/js/leaderboard.js"></script>
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-to-content">Skip to main content</a>

  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="header-fog" aria-hidden="true"></div>
    <div class="header-particles" aria-hidden="true"></div>
    <div class="header-content">
      <p class="header-subtitle">Admin Panel</p>
      <h1>Leaderboard Administration</h1>
      <p>View user statistics, exam counts, and detailed attempt history.</p>
    </div>
  </header>

  <main id="main-content" class="admin-wrapper">
    <!-- Back link -->
    <div class="back-link">
      <a href="index.html">‚Üê Back to Admin Hub</a> | 
      <a href="../../index.html">‚Üê Back to Main Site</a>
    </div>

    <!-- Admin header -->
    <header class="admin-header">
      <h2>User Statistics Dashboard</h2>
      <p>Review per-user exam counts, module performance, and detailed attempt logs.</p>
    </header>

    <!-- Access control section -->
    <section id="access-section" aria-labelledby="access-heading">
      
      <!-- GitHub OAuth Authentication Section -->
      <div id="github-auth-section"></div>

      <!-- Access denied message (shown when no valid access) -->
      <div class="admin-access-denied" id="access-denied" style="display: none;">
        <h3 id="access-heading">Admin Access Required</h3>
        <p>
          This page requires admin authentication via GitHub OAuth.
        </p>
        <p style="margin-top: var(--space-3);">
          Only the authorized GitHub account can access this page.
        </p>
      </div>

    </section>

    <!-- Admin content (hidden until authenticated) -->
    <div id="admin-content" style="display: none;">
      
      <!-- Summary stats -->
      <section class="admin-section" aria-labelledby="stats-heading">
        <h3 id="stats-heading">Overview Statistics</h3>
        <div class="admin-stats-grid" id="stats-grid">
          <div class="admin-stat-card">
            <h4>Total Users</h4>
            <div class="admin-stat-value" id="stat-users">-</div>
          </div>
          <div class="admin-stat-card">
            <h4>Total Exams Taken</h4>
            <div class="admin-stat-value" id="stat-exams">-</div>
          </div>
          <div class="admin-stat-card">
            <h4>Average Score</h4>
            <div class="admin-stat-value" id="stat-avg-score">-</div>
          </div>
          <div class="admin-stat-card">
            <h4>Data Source</h4>
            <div class="admin-stat-value" id="stat-source" style="font-size: var(--font-size-base);">Sample</div>
          </div>
        </div>
      </section>

      <!-- Per-user stats table -->
      <section class="admin-section" aria-labelledby="users-heading">
        <h3 id="users-heading">Per-User Statistics</h3>
        <div id="users-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Total Exams</th>
                <th>Modules Attempted</th>
                <th>Best Score</th>
                <th>Avg Score</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <tr>
                <td colspan="5" style="text-align: center; padding: var(--space-6);">
                  Loading user data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Attempt history -->
      <section class="admin-section" aria-labelledby="history-heading">
        <h3 id="history-heading">Recent Attempt History</h3>
        <div id="history-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Module</th>
                <th>Exam</th>
                <th>Score</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody id="history-table-body">
              <tr>
                <td colspan="5" style="text-align: center; padding: var(--space-6);">
                  Loading attempt history...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="admin-pagination" id="history-pagination">
          <button id="prev-page" disabled>‚Üê Previous</button>
          <button id="next-page" disabled>Next ‚Üí</button>
        </div>
      </section>

      <!-- Security notice -->
      <aside class="security-notice">
        <h4>üîí Security Guidance</h4>
        <p>
          <strong>Audit Logging:</strong> To enable server-side audit logs for admin access,
          configure Cloud Functions to log all reads from admin endpoints. See 
          <code>docs/leaderboard-design.md</code> for implementation details.
        </p>
        <p style="margin-top: var(--space-2);">
          <strong>This Page:</strong> Admin access is logged locally in the browser console.
          For production, implement server-side logging via Cloud Functions or your backend.
        </p>
      </aside>
    </div>

  </main>

  <footer class="site-footer" role="contentinfo">
    <span>Admin Panel ‚Ä¢ Leaderboard Statistics</span>
    <span>Access restricted to authorized administrators</span>
  </footer>

  <script>
    // Admin page initialization
    ;(function() {
      'use strict';

      // Configuration - GitHub OAuth Only
      var isAuthenticated = false;
      var adminData = null;
      var currentUser = null;

      // DOM elements
      var accessDeniedEl = document.getElementById('access-denied');
      var githubAuthSectionEl = document.getElementById('github-auth-section');
      var adminContentEl = document.getElementById('admin-content');
      var usersTableBody = document.getElementById('users-table-body');
      var historyTableBody = document.getElementById('history-table-body');

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', init);

      function init() {
        // Log access attempt (for local auditing)
        logAdminAccess('Page loaded');

        // Check access - GitHub OAuth only
        checkAccess();
        
        // Set up event listeners
        setupEventListeners();
        
        // Listen for successful login events
        window.addEventListener('githubauth:login', function(event) {
          console.log('Login event received, refreshing UI...');
          // Re-check access to show authenticated content
          checkAccess();
        });
      }

      function setupEventListeners() {
        // Pagination
        document.getElementById('prev-page').addEventListener('click', function() {
          // Pagination would be implemented with actual backend
          console.log('Previous page');
        });
        document.getElementById('next-page').addEventListener('click', function() {
          console.log('Next page');
        });
      }

      async function checkAccess() {
        // Check if GitHub Auth is available
        if (!window.GitHubAuth) {
          console.error('GitHub Auth module not loaded');
          accessDeniedEl.style.display = 'block';
          return;
        }
        
        // Require GitHub OAuth authentication only
        try {
          var user = await GitHubAuth.requireAuth();
          // User is authenticated via GitHub OAuth
          currentUser = user;
          logAdminAccess('Authenticated via GitHub: ' + user.username);
          showUserInfo(user);
          grantAccess();
        } catch (err) {
          // Not authenticated - show login UI
          if (githubAuthSectionEl) {
            await GitHubAuth.showAuthUI('github-auth-section');
          } else {
            accessDeniedEl.style.display = 'block';
          }
        }
      }
      
      function showUserInfo(user) {
        // Add user info to header
        var header = document.querySelector('.admin-header');
        if (header && user) {
          var userInfo = document.createElement('div');
          userInfo.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px;';
          
          // Create elements safely to prevent XSS
          var img = document.createElement('img');
          // Validate avatar URL is from trusted sources only
          var defaultAvatar = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><circle cx="16" cy="16" r="16" fill="%23ccc"/></svg>';
          
          if (user.avatar) {
            // Only allow HTTPS URLs from trusted domains
            var trustedDomains = [
              'https://avatars.githubusercontent.com/',
              'https://lh3.googleusercontent.com/',
              'https://graph.facebook.com/',
              'https://platform-lookaside.fbsbx.com/'
            ];
            
            var isTrusted = trustedDomains.some(function(domain) {
              return user.avatar.startsWith(domain);
            });
            
            if (isTrusted) {
              img.src = user.avatar;
            } else {
              console.warn('Untrusted avatar URL, using default:', user.avatar);
              img.src = defaultAvatar;
            }
          } else {
            img.src = defaultAvatar;
          }
          img.alt = 'User avatar';
          img.style.cssText = 'width: 32px; height: 32px; border-radius: 50%;';
          
          var userDetails = document.createElement('div');
          userDetails.style.cssText = 'flex: 1;';
          
          var authText = document.createElement('div');
          authText.style.fontWeight = '600';
          // Sanitize username - only allow alphanumeric, dash, and underscore (GitHub username rules)
          var safeUsername = (user.username || 'Unknown').replace(/[^a-zA-Z0-9-_]/g, '');
          authText.textContent = 'Authenticated as ' + safeUsername;
          
          var oauthLabel = document.createElement('div');
          oauthLabel.style.cssText = 'font-size: 0.9rem; opacity: 0.8;';
          oauthLabel.textContent = 'GitHub via Firebase';
          
          var logoutBtn = document.createElement('button');
          logoutBtn.textContent = 'Logout';
          logoutBtn.style.cssText = 'padding: 6px 12px; background: var(--color-accent); color: white; border: none; border-radius: 4px; cursor: pointer;';
          logoutBtn.onclick = function() { GitHubAuth.logout(); };
          
          userDetails.appendChild(authText);
          userDetails.appendChild(oauthLabel);
          userInfo.appendChild(img);
          userInfo.appendChild(userDetails);
          userInfo.appendChild(logoutBtn);
          header.appendChild(userInfo);
        }
      }

      function grantAccess() {
        isAuthenticated = true;
        accessDeniedEl.style.display = 'none';
        adminContentEl.style.display = 'block';
        
        // Load admin data
        loadAdminData();
      }

      async function loadAdminData() {
        // Check if Firebase admin functions are available
        if (window.LeaderboardFirebase && await window.LeaderboardFirebase.isAdmin()) {
          // Load from Firebase
          loadFirebaseAdminData();
        } else {
          // Load sample data for demo
          loadSampleAdminData();
        }
      }

      async function loadFirebaseAdminData() {
        try {
          var userStats = await window.LeaderboardFirebase.getAdminUserStats();
          var historyResult = await window.LeaderboardFirebase.getAdminAttemptHistory({ limit: 20 });
          
          document.getElementById('stat-source').textContent = 'Live';
          renderAdminData(userStats, historyResult.attempts);
        } catch (error) {
          console.error('Failed to load admin data:', error);
          loadSampleAdminData();
        }
      }

      async function loadSampleAdminData() {
        // Load sample data for demo/preview
        var basePath = getBasePath();
        
        try {
          var response = await fetch(basePath + 'assets/data/leaderboard-sample.json');
          var data = await response.json();
          
          document.getElementById('stat-source').textContent = 'Sample';
          renderAdminData(data.adminData.userStats, data.adminData.attemptHistory);
        } catch (error) {
          console.error('Failed to load sample data:', error);
          usersTableBody.innerHTML = '<tr><td colspan="5">Failed to load data</td></tr>';
          historyTableBody.innerHTML = '<tr><td colspan="5">Failed to load data</td></tr>';
        }
      }

      function renderAdminData(userStats, attemptHistory) {
        // Calculate summary stats
        var totalUsers = userStats.length;
        var totalExams = 0;
        var totalScore = 0;
        var scoreCount = 0;

        for (var i = 0; i < userStats.length; i++) {
          totalExams += userStats[i].totalExams;
          var breakdown = userStats[i].moduleBreakdown;
          for (var moduleId in breakdown) {
            if (breakdown.hasOwnProperty(moduleId)) {
              totalScore += breakdown[moduleId].averageScore * breakdown[moduleId].attempts;
              scoreCount += breakdown[moduleId].attempts;
            }
          }
        }

        document.getElementById('stat-users').textContent = totalUsers;
        document.getElementById('stat-exams').textContent = totalExams;
        document.getElementById('stat-avg-score').textContent = scoreCount > 0 
          ? Math.round(totalScore / scoreCount) + '%' 
          : '-';

        // Render users table
        renderUsersTable(userStats);

        // Render attempt history
        renderHistoryTable(attemptHistory);
      }

      function renderUsersTable(userStats) {
        if (!userStats || userStats.length === 0) {
          usersTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No user data available</td></tr>';
          return;
        }

        var html = '';
        for (var i = 0; i < userStats.length; i++) {
          var user = userStats[i];
          var breakdown = user.moduleBreakdown;
          var moduleCount = Object.keys(breakdown).length;
          
          var bestScore = 0;
          var totalScore = 0;
          var attemptCount = 0;
          
          for (var moduleId in breakdown) {
            if (breakdown.hasOwnProperty(moduleId)) {
              if (breakdown[moduleId].bestScore > bestScore) {
                bestScore = breakdown[moduleId].bestScore;
              }
              totalScore += breakdown[moduleId].averageScore;
              attemptCount++;
            }
          }
          
          var avgScore = attemptCount > 0 ? Math.round(totalScore / attemptCount) : 0;
          
          html += '<tr>';
          html += '<td>' + escapeHtml(user.username) + '</td>';
          html += '<td>' + user.totalExams + '</td>';
          html += '<td>' + moduleCount + '</td>';
          html += '<td>' + bestScore + '%</td>';
          html += '<td>' + avgScore + '%</td>';
          html += '</tr>';
        }
        
        usersTableBody.innerHTML = html;
      }

      function renderHistoryTable(attemptHistory) {
        if (!attemptHistory || attemptHistory.length === 0) {
          historyTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No attempt history available</td></tr>';
          return;
        }

        var html = '';
        for (var i = 0; i < attemptHistory.length; i++) {
          var attempt = attemptHistory[i];
          html += '<tr>';
          html += '<td>' + escapeHtml(attempt.username) + '</td>';
          html += '<td>' + escapeHtml(attempt.moduleId) + '</td>';
          html += '<td>' + escapeHtml(attempt.examId) + '</td>';
          html += '<td>' + attempt.score + '%</td>';
          html += '<td>' + formatTimestamp(attempt.timestamp) + '</td>';
          html += '</tr>';
        }
        
        historyTableBody.innerHTML = html;
      }

      function logAdminAccess(action) {
        var logEntry = {
          timestamp: new Date().toISOString(),
          action: action,
          userAgent: navigator.userAgent,
          url: window.location.href
        };
        
        console.log('[ADMIN ACCESS LOG]', logEntry);
        
        // In production, this should be sent to a server-side logging service
        // For now, we just log to console and could optionally store locally
        try {
          var logs = JSON.parse(localStorage.getItem('admin_access_log') || '[]');
          logs.push(logEntry);
          // Keep only last 100 entries
          if (logs.length > 100) {
            logs = logs.slice(-100);
          }
          localStorage.setItem('admin_access_log', JSON.stringify(logs));
        } catch (e) {
          // localStorage may be unavailable
        }
      }

      function getBasePath() {
        var path = window.location.pathname;
        var parts = path.split('/').filter(function(p) { return p && !p.includes('.html'); });
        if (parts.length === 0) return '';
        return '../'.repeat(parts.length);
      }

      function escapeHtml(str) {
        if (!str) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function formatTimestamp(isoString) {
        try {
          var date = new Date(isoString);
          return date.toLocaleDateString(undefined, {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch (e) {
          return 'Unknown';
        }
      }

    })();
  </script>
</body>
</html>
